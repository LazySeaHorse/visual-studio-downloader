name: Build VS 2026 Community Offline Installer

on:
  push:
    tags:
      - 'v*'
      - 'release-*'
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name (optional)'
        required: false
        default: ''

env:
  VS_BOOTSTRAPPER_URL: https://aka.ms/vs/17/release/vs_community.exe  # Update when VS 2026 is available
  LAYOUT_PATH: ./vs_offline
  ARCHIVE_NAME: VS2026_Community_Offline
  MAX_PART_SIZE: 1900M  # Keep under 2GB limit with buffer

jobs:
  build-installer:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment
      shell: pwsh
      run: |
        Write-Host "Runner specs:"
        Get-CimInstance Win32_ComputerSystem | Select-Object TotalPhysicalMemory, NumberOfProcessors
        Get-PSDrive C | Select-Object Used, Free
        
    - name: Cache VS Layout
      id: cache-layout
      uses: actions/cache@v3
      with:
        path: ${{ env.LAYOUT_PATH }}
        key: vs-layout-${{ github.sha }}
        restore-keys: |
          vs-layout-

    - name: Download VS Bootstrapper
      if: steps.cache-layout.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "Downloading Visual Studio Bootstrapper..."
        $ProgressPreference = 'SilentlyContinue'
        Invoke-WebRequest -Uri "${{ env.VS_BOOTSTRAPPER_URL }}" -OutFile "vs_community.exe"
        
    - name: Create VS Offline Layout
      if: steps.cache-layout.outputs.cache-hit != 'true'
      shell: cmd
      timeout-minutes: 240
      run: |
        echo Starting Visual Studio offline layout creation...
        vs_community.exe ^
          --layout %LAYOUT_PATH% ^
          --add Microsoft.VisualStudio.Workload.ManagedDesktop ^
          --includeRecommended ^
          --lang en-US ^
          --quiet ^
          --wait
        echo Layout creation completed with exit code %ERRORLEVEL%

    - name: Verify layout size
      shell: pwsh
      run: |
        $layoutSize = (Get-ChildItem -Path "${{ env.LAYOUT_PATH }}" -Recurse | 
                      Measure-Object -Property Length -Sum).Sum
        $layoutSizeGB = [math]::Round($layoutSize / 1GB, 2)
        Write-Host "Layout size: $layoutSizeGB GB"
        
        if ($layoutSizeGB -gt 12) {
          Write-Warning "Layout exceeds 12GB. Consider reducing workloads."
        }
        
        # Save size for later steps
        echo "LAYOUT_SIZE_GB=$layoutSizeGB" >> $env:GITHUB_ENV

    - name: Install 7-Zip
      shell: pwsh
      run: |
        Write-Host "Installing 7-Zip..."
        $7zUrl = "https://www.7-zip.org/a/7z2301-x64.msi"
        Invoke-WebRequest -Uri $7zUrl -OutFile "7z-installer.msi"
        Start-Process msiexec.exe -ArgumentList "/i", "7z-installer.msi", "/quiet" -Wait
        $env:PATH += ";C:\Program Files\7-Zip"
        echo "C:\Program Files\7-Zip" >> $env:GITHUB_PATH

    - name: Create split archive
      shell: pwsh
      run: |
        Write-Host "Creating split archive with 7-Zip..."
        $archiveName = "${{ env.ARCHIVE_NAME }}.7z"
        
        # Create archive with maximum compression and split into parts
        & "C:\Program Files\7-Zip\7z.exe" a -t7z -mx=5 -v${{ env.MAX_PART_SIZE }} `
          "$archiveName" "${{ env.LAYOUT_PATH }}\*" -mmt=on
        
        # List created parts
        Get-ChildItem -Filter "${{ env.ARCHIVE_NAME }}.7z*" | ForEach-Object {
          Write-Host "$($_.Name): $([math]::Round($_.Length / 1MB, 2)) MB"
        }
        
        # Count parts for upload
        $partCount = (Get-ChildItem -Filter "${{ env.ARCHIVE_NAME }}.7z.*").Count
        echo "PART_COUNT=$partCount" >> $env:GITHUB_ENV

    - name: Generate checksums
      shell: pwsh
      run: |
        Write-Host "Generating checksums..."
        $checksumFile = "checksums.txt"
        
        Get-ChildItem -Filter "${{ env.ARCHIVE_NAME }}.7z*" | ForEach-Object {
          $hash = (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash
          "$hash  $($_.Name)" | Out-File -Append -FilePath $checksumFile
        }
        
        Write-Host "Checksums:"
        Get-Content $checksumFile

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: vs-offline-parts
        path: |
          ${{ env.ARCHIVE_NAME }}.7z*
          checksums.txt
        retention-days: 1

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ github.ref_name }}
        name: ${{ inputs.release_name || format('VS 2026 Community Offline - {0}', github.ref_name) }}
        draft: false
        prerelease: false
        body: |
          ## Visual Studio 2026 Community Offline Installer
          
          This release contains an offline installer for Visual Studio 2026 Community with:
          - **Workload**: Managed Desktop Development (WinForms, WPF, C#)
          - **Components**: Recommended components including .NET Framework 4.8
          - **Language**: English (en-US)
          - **Total Size**: ~${{ env.LAYOUT_SIZE_GB }} GB
          
          ### üì¶ Installation Instructions
          
          1. Download all `.7z` parts (001, 002, etc.) to the same folder
          2. Download `checksums.txt` to verify integrity
          3. Extract using 7-Zip: Right-click on the `.7z.001` file and select "Extract Here"
          4. Run `vs_community.exe` from the extracted folder
          5. Select "Install from layout folder" when prompted
          
          ### ‚úÖ Verify Downloads
          
          Use the provided `checksums.txt` to verify file integrity:
          ```powershell
          Get-Content checksums.txt | ForEach-Object {
            $parts = $_ -split '  '
            $hash = (Get-FileHash -Path $parts[1] -Algorithm SHA256).Hash
            if ($hash -eq $parts[0]) {
              Write-Host "‚úì $($parts[1])" -ForegroundColor Green
            } else {
              Write-Host "‚úó $($parts[1])" -ForegroundColor Red
            }
          }
          ```
          
          ### üìù Archive Information
          - Archive format: 7-Zip
          - Compression: Level 5 (balanced)
          - Parts: ${{ env.PART_COUNT }} files
          - Max part size: ${{ env.MAX_PART_SIZE }}
        files: |
          ${{ env.ARCHIVE_NAME }}.7z*
          checksums.txt

    - name: Cleanup workspace
      if: always()
      shell: pwsh
      run: |
        Write-Host "Cleaning up workspace..."
        if (Test-Path "${{ env.LAYOUT_PATH }}") {
          Remove-Item -Path "${{ env.LAYOUT_PATH }}" -Recurse -Force
        }
        Get-ChildItem -Filter "*.7z*" | Remove-Item -Force
        if (Test-Path "vs_community.exe") {
          Remove-Item "vs_community.exe" -Force
        }
